<!doctype html>
<html>

<head>
  <title>校園空氣品質監測</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="http://marty5499.github.io/air-schools/bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="http://marty5499.github.io/air-schools/bower_components/google-map/google-map.html">
  <link rel="import" href="http://marty5499.github.io/air-schools/bower_components/google-map/google-map-marker.html">

  <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
  <script type="text/javascript" src="https://webduino.io/components/webduino-js/dist/webduino-all.min.js"></script>
  <script type="text/javascript" src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>

  <style>
  .icon {
    margin: 10px;
    width: 64px;
  }
  .gmap {
    height: 100vh;
  }
  .help {
    height: 100vh;
  }
  .state {
    margin: 0 auto;
    width: 100%;
    color: Red;
  }
  .ui-title {
    margin: 0.0em 10% 0.0em !important;
  }
  #initPage .ui-content {
    padding: 0px;
  }
  body {
    margin: 0;
    height: 100vh;
  }
  .info {
    position: fixed;
    background-color: #fafafa;
    padding: 5px;
    left: 3%;
    bottom: 10%;
    font-size: 14px;
  }
  </style>
</head>

<body>
  <div id="initPage" data-role="page">
    <div data-role="header" data-position="fixed" data-theme="b">
      <h1>高雄市校園空氣品質監測</h1>
      <a class="ui-btn ui-btn-right ui-corner-all" href="#helpPage">說明</a>
      <!-- <a class="ui-btn ui-btn-left" href="#chartPage">圖表</a> -->
    </div>
    <div role="main" class="ui-content">

      <google-map latitude="22.630080" longitude="120.343402" id="gmap" min-zoom="3" max-zoom="20" language="zh_tw" zoom="17" disabledefaultui="">
      </google-map>
      <div class="info">
        <select id="schools-select" data-mini="true">
        </select>
        <div>時間:
          <span id="showTime">??/??/?? ??:??:??</span>
        </div>
        <div>PM 2.5:
          <span id="showPM25">??</span> μg/m<sup>3</sup>
        </div>
        <div>PM 10:
          <span id="showPM10">??</span> μg/m<sup>3</sup>
        </div>
      </div>
    </div>
  </div>

  <div id="helpPage" data-role="page">
    <div data-role="header" data-position="fixed" data-theme="b">
      <h1>校園空氣品質監測</h1>
      <a class="ui-btn ui-btn-left ui-corner-all" href="#initPage">返回</a>
    </div>
    <div role="main" class="ui-content">
      <iframe style="width:100%" src="http://taqm.epa.gov.tw/taqm/tw/fpmi.htm" class="help"></iframe>
    </div>
  </div>
  <!-- initPage -->
  <script>
  var db, markerMap = {}, options = [];
  var selectMarker;
  var type = window.location.hash.substr(1);

  $(document).one("pagecontainershow", function(evt, obj) {
    ScaleContentToDevice();
    
    $(window).on("resize orientationchange", function(){
      var activePage = $('body').pagecontainer('getActivePage')[0];
      if (activePage.id === 'initPage') {
        ScaleContentToDevice();
      }
    })
  });

  gmap.addEventListener('google-map-ready', function(e) {
    db = new Firebase("https://air-schools.firebaseio.com/list");
    update();
  });

  function ScaleContentToDevice() {
    scroll(0, 0);
    var content = $.mobile.getScreenHeight() - $(".ui-header").outerHeight() - $(".ui-footer").outerHeight() - $(".ui-content").outerHeight() + $(".ui-content").height();
    $("#initPage .ui-content").height(content);
  }

  function toggleControls() {
    gmap.disableDefaultUi = !gmap.disableDefaultUi;
  }

  function addOptions(key, obj) {
    if (obj.title) {
      options.push('<option value="' + key + '"' + (key === type ? "selected" : "") + '>' + key + ' ' + obj.title + '</option>');
    }
    
    if (options.length === 1) {
      setTimeout(timer, 0);
    }

    function timer() {
      var $select = $('#schools-select');
      $select.html(options.join(''));
      $select.selectmenu("refresh", true);

      $select.on('change', function() {
        var id = $select.children('option:checked')[0].value;
        var marker = $(gmap).find('#' + id).get(0);
        updateShowInfo(marker);
        selectMarker = marker;
        for (key in markerMap) {
          markerMap[key].marker.setLabel({
            text: ' ',
            color: 'red',
            fontSize: '32px',
            top: '100px'
          });
        }
        marker.marker.setLabel({
          text: '_',
          color: 'red',
          fontSize: '32px',
          top: '100px'
        });
        gmap.map.setCenter(marker.marker.getPosition());
      });

      // show Marker on the GoogleMap center, coming first.
      $select.trigger('change');
    }

  }

  function addMarker(key, obj) {
    var marker = document.createElement('google-map-marker');
    markerMap[key] = marker;
    marker.id = obj.id = key;
    updateMarker(marker, obj);
    Polymer.dom(gmap).appendChild(marker);
    setTimeout(timer, 0);

    function timer() {
      marker.marker.addListener('dragend', function(e) {
        var data = db.child('devices/' + marker.id);
        data.update({
          "lat": e.latLng.lat(),
          "lng": e.latLng.lng()
        });
      });
      marker.marker.addListener('click', function(e) {
        updateShowInfo(marker);
        selectMarker = marker;
        for (key in markerMap) {
          markerMap[key].marker.setLabel({
            text: ' ',
            color: 'red',
            fontSize: '32px',
            top: '100px'
          });
        }
        marker.marker.setLabel({
          text: '_',
          color: 'red',
          fontSize: '32px',
          top: '100px'
        });

        // update select option
        var $select = $('#schools-select');
        $select.children('option[value="' + marker.id + '"]').attr('selected', 'selected');
        $select.selectmenu('refresh');
      });
    }
  }

  function updateShowInfo(marker) {
    if (marker !== null) {
      if (marker.obj.hasOwnProperty('time')) {
        var pickupDate = marker.obj.time.split(' ')[0].replace(/-/g, "/");
        var hash = marker.id + "," + pickupDate;
        showTime.innerHTML =
          "<a href='chart.html#" + hash + "' target='_self'>" + marker.obj.time + "</a>";
        showPM25.innerHTML = marker.obj.pm25;
        showPM10.innerHTML = marker.obj.pm10;
      } else {
        showTime.innerHTML = "??/??/?? ??:??:??";
        showPM25.innerHTML = "??";
        showPM10.innerHTML = "??";
      }
    }
  }

  function updateMarker(marker, obj) {
    marker.obj = obj;
    var iconSize = obj.icon.endsWith("off-line.png") ? 20 : 38;
    console.log(obj.icon);
    var image = {
      url: obj.icon,
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(0, 0),
      scaledSize: new google.maps.Size(iconSize, iconSize)
    };
    marker.icon = image;
    if (obj.hasOwnProperty('lat')) {
      marker.latitude = obj.lat;
      marker.longitude = obj.lng;
    } else {
      address(obj, marker);
    }
    marker.title = obj.title;
    if (marker.id === type) {
      marker.draggable = "true";
      marker.mouseevents = "true";
    }
    if (typeof(selectMarker) !== "undefined" && marker.id === selectMarker.id) {
      updateShowInfo(marker);
    }
  }

  function update() {
    db.on("value", function(snapshot) {
      snapshot.forEach(function(data) {
        var devices = data.val();
        var ele;
        var markerObj;

        for (var key in devices) {
          ele = document.getElementById(key);
          markerObj = devices[key];
          if (ele === null) {
            addOptions(key, markerObj)
            addMarker(key, markerObj);
            if (key == type) {
              if (!markerObj.hasOwnProperty('lat')) {
                address(markerObj, gmap);
              }
            }
          } else {
            updateMarker(ele, markerObj);
          }
  </script><!-- /initPage -->
        }
      });
    }, function(errorObject) {
      console.log("The read failed: " + errorObject.code);
    });
  }

  function address(markerObj, mapObj) {
    if (markerObj.address) {
      new google.maps.Geocoder().geocode({
          address: markerObj.address
        },
        function(result, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            mapObj.latitude = result[0].geometry.location.lat();
            mapObj.longitude = result[0].geometry.location.lng();
            var data = db.child('devices/' + markerObj.id);
            data.update({
              "lat": mapObj.latitude,
              "lng": mapObj.longitude
            });
          } else {
            console.log('query address error:', status);
          }
        }
      );
    } else {
      console.log('no address: id:', markerObj.id);
    }
  }
  </script>
</body>

</html>